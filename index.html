<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Quiz App</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts - Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            /* Updated background: light blue, soft grey, pastel/natural mix */
            background: linear-gradient(135deg, #e0f2fe 0%, #cfd8dc 50%, #f0f4f8 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 1rem;
            box-sizing: border-box;
        }
        .container {
            width: 100%;
            max-width: 960px; /* Max width for larger screens */
            background-color: #ffffff;
            border-radius: 1.5rem; /* More rounded corners */
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); /* Stronger shadow */
            padding: 2.5rem; /* More padding */
            box-sizing: border-box;
            border: 1px solid #e2e8f0; /* Subtle border */
        }
        .hidden {
            display: none !important;
        }
        .btn-primary {
            /* More vibrant primary button */
            @apply bg-gradient-to-r from-blue-500 to-blue-700 text-white px-6 py-3 rounded-xl hover:from-blue-600 hover:to-blue-800 transition duration-300 ease-in-out shadow-lg focus:outline-none focus:ring-4 focus:ring-blue-300 focus:ring-opacity-75;
        }
        .btn-secondary {
            /* Slightly more styled secondary button */
            @apply bg-gray-100 text-gray-700 px-5 py-2.5 rounded-xl hover:bg-gray-200 transition duration-300 ease-in-out shadow-md focus:outline-none focus:ring-2 focus:ring-gray-300 focus:ring-opacity-50;
        }
        input[type="text"],
        input[type="email"],
        input[type="password"],
        select,
        textarea {
            @apply w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200 ease-in-out;
        }
        .card {
            @apply bg-white p-6 rounded-lg shadow-md border border-gray-200;
        }
        .quiz-option {
            @apply flex items-center p-4 border border-gray-300 rounded-lg mb-2 cursor-pointer hover:bg-blue-50 transition duration-200 ease-in-out;
        }
        /* Changed selected color to ash/light grey */
        .quiz-option.selected {
            @apply bg-gray-200 border-gray-400 ring-2 ring-gray-400;
        }
        /* Correct answer feedback (ash/slate) */
        .quiz-option.correct {
            @apply bg-slate-100 border-slate-400 ring-2 ring-slate-400;
        }
        .quiz-option.incorrect {
            @apply bg-red-100 border-red-500 ring-2 ring-red-500;
        }
        .message-box {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            z-index: 1000;
            text-align: center;
            max-width: 400px;
            width: 90%;
            border: 1px solid #ddd;
        }
        .message-box button {
            margin-top: 15px;
            padding: 10px 20px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        .message-box button:hover {
            background-color: #45a049;
        }
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 999;
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #3b82f6;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Message Box Container -->
        <div id="messageBoxContainer"></div>

        <!-- Authentication Section -->
        <section id="auth-section" class="space-y-6">
            <h2 class="text-3xl font-bold text-center text-gray-800 mb-8">Welcome to Smart Quiz App</h2>

            <!-- Login Form -->
            <div id="login-form" class="card max-w-md mx-auto">
                <h3 class="text-2xl font-semibold mb-6 text-center text-gray-700">Login</h3>
                <form class="space-y-4">
                    <div>
                        <label for="login-email" class="block text-gray-700 text-sm font-medium mb-1">Email</label>
                        <input type="email" id="login-email" placeholder="your@example.com" required>
                    </div>
                    <div>
                        <label for="login-password" class="block text-gray-700 text-sm font-medium mb-1">Password</label>
                        <input type="password" id="login-password" placeholder="********" required>
                    </div>
                    <button type="submit" class="btn-primary w-full" id="login-submit-btn">Login</button>
                </form>
                <p class="text-center text-sm text-gray-600 mt-4">
                    Don't have an account? <a href="#" class="text-blue-600 hover:underline" id="show-register-form-link">Register</a>
                </p>
                <p class="text-center text-sm text-gray-600 mt-2">
                    <a href="#" class="text-blue-600 hover:underline" id="show-forgot-password-form-link">Forgot Password?</a>
                </p>
                <p id="auth-error-message" class="text-red-600 mt-4 hidden"></p>
            </div>

            <!-- Register Form (Initially Hidden) -->
            <div id="register-form" class="card max-w-md mx-auto hidden">
                <h3 class="text-2xl font-semibold mb-6 text-center text-gray-700">Register</h3>
                <form class="space-y-4">
                    <div>
                        <label for="register-username" class="block text-gray-700 text-sm font-medium mb-1">Username</label>
                        <input type="text" id="register-username" placeholder="Choose a username" required>
                    </div>
                    <div>
                        <label for="register-email" class="block text-gray-700 text-sm font-medium mb-1">Email</label>
                        <input type="email" id="register-email" placeholder="your@example.com" required>
                    </div>
                    <div>
                        <label for="register-password" class="block text-gray-700 text-sm font-medium mb-1">Password</label>
                        <input type="password" id="register-password" placeholder="********" required>
                    </div>
                    <button type="submit" class="btn-primary w-full" id="register-submit-btn">Register</button>
                </form>
                <p class="text-center text-sm text-gray-600 mt-4">
                    Already have an account? <a href="#" class="text-blue-600 hover:underline" id="show-login-form-link-from-register">Login</a>
                </p>
            </div>

            <!-- Forgot Password Form (Initially Hidden) -->
            <div id="forgot-password-form" class="card max-w-md mx-auto hidden">
                <h3 class="text-2xl font-semibold mb-6 text-center text-gray-700">Forgot Password</h3>
                <form class="space-y-4">
                    <div>
                        <label for="forgot-email" class="block text-gray-700 text-sm font-medium mb-1">Email</label>
                        <input type="email" id="forgot-email" placeholder="your@example.com" required>
                    </div>
                    <button type="submit" class="btn-primary w-full" id="forgot-password-submit-btn">Reset Password</button>
                </form>
                <p class="text-center text-sm text-gray-600 mt-4">
                    Remembered your password? <a href="#" class="text-blue-600 hover:underline" id="show-login-form-link-from-forgot">Login</a>
                </p>
            </div>
        </section>

        <!-- User Dashboard Section (Initially Hidden) -->
        <section id="user-dashboard-section" class="hidden space-y-8">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-3xl font-bold text-gray-800">Welcome, <span id="dashboard-username">User</span>!</h2>
                <div class="flex space-x-4">
                    <button class="btn-secondary" id="profile-btn">Profile</button>
                    <button class="btn-secondary" id="take-quiz-btn">Take Quiz</button>
                    <button class="btn-secondary" id="logout-btn-dashboard">Logout</button>
                </div>
            </div>

            <!-- Dashboard User Stats Summary -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="card flex flex-col items-center justify-center p-6 bg-blue-50 border-blue-200">
                    <p class="text-5xl font-extrabold text-blue-600" id="dashboard-total-quizzes">0</p>
                    <p class="text-lg font-semibold text-gray-700">Quizzes Taken</p>
                </div>
                <div class="card flex flex-col items-center justify-center p-6 bg-purple-50 border-purple-200">
                    <p class="text-5xl font-extrabold text-purple-600" id="dashboard-average-score">0%</p>
                    <p class="text-lg font-semibold text-gray-700">Average Score</p>
                </div>
            </div>

            <!-- Featured Quiz Section -->
            <div id="featured-quiz-section" class="card hidden">
                <h3 class="text-2xl font-semibold mb-4 text-gray-700">Featured Quiz Today! ✨</h3>
                <p class="text-xl font-bold text-blue-700 mb-2" id="featured-quiz-topic"></p>
                <p class="text-gray-600 mb-4" id="featured-quiz-details"></p>
                <button class="btn-primary w-full" id="take-featured-quiz-btn">Take Featured Quiz</button>
            </div>

            <!-- Quiz Selection -->
            <div id="quiz-selection" class="card">
                <h3 class="text-2xl font-semibold mb-6 text-gray-700">Select a Quiz Topic</h3>
                <!-- Quiz Category Filter (New) -->
                <div class="mb-4">
                    <label for="quiz-category-filter" class="block text-gray-700 text-sm font-medium mb-1">Filter by Category:</label>
                    <select id="quiz-category-filter" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200 ease-in-out">
                        <option value="">All Categories</option>
                        <option value="General Knowledge">General Knowledge</option>
                        <option value="Academic">Academic</option>
                        <option value="Fun">Fun</option>
                        <option value="AI Generated">AI Generated</option>
                    </select>
                </div>
                <!-- Quiz Search Input -->
                <input type="text" id="quiz-search-input" placeholder="Search quizzes by topic..."
                       class="w-full p-3 border border-gray-300 rounded-lg mb-4 focus:ring-2 focus:ring-blue-400 focus:border-transparent transition-all duration-200">

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="quiz-topics-container">
                    <!-- Quiz topics will be dynamically loaded here -->
                </div>
                <button id="start-selected-quiz-btn" class="btn-primary w-full mt-6 hidden">Start Quiz</button>

                <div class="mt-8 pt-6 border-t border-gray-200">
                    <h3 class="text-2xl font-semibold mb-4 text-gray-700">Generate AI Quiz</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label for="ai-num-questions-input" class="block text-gray-700 text-sm font-medium mb-1">Number of Questions:</label>
                            <input type="number" id="ai-num-questions-input" value="5" min="1" max="15"
                                   class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-400 focus:border-transparent transition-all duration-200">
                        </div>
                        <div>
                            <label for="ai-difficulty-select" class="block text-gray-700 text-sm font-medium mb-1">Difficulty:</label>
                            <select id="ai-difficulty-select" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-400 focus:border-transparent transition-all duration-200">
                                <option value="easy">Easy</option>
                                <option value="medium">Medium</option>
                                <option value="hard">Hard</option>
                            </select>
                        </div>
                    </div>
                    <input type="text" id="ai-topic-input" placeholder="Enter quiz topic (e.g., 'History', 'Science')"
                           class="w-full p-3 border border-gray-300 rounded-lg mb-4 focus:ring-2 focus:ring-blue-400 focus:border-transparent transition-all duration-200">
                    <button id="generate-ai-quiz-btn" class="btn-primary w-full">Generate AI Quiz</button>
                    <div id="ai-loading-spinner" class="hidden mt-4 flex items-center justify-center text-blue-600">
                        <div class="spinner mr-2"></div>
                        Generating questions...
                    </div>
                    <p id="ai-generation-error-message" class="text-red-600 mt-4 hidden"></p>
                </div>
            </div>

            <!-- Leaderboard Section -->
            <div id="leaderboard-section" class="card">
                <h3 class="text-2xl font-semibold mb-6 text-gray-700">Top Quizzers 🏆</h3>
                <ul id="leaderboard-list" class="space-y-2 text-gray-700">
                    <!-- Leaderboard entries will be dynamically loaded here -->
                    <li class="text-gray-500">No users on the leaderboard yet.</li>
                </ul>
            </div>

            <!-- Profile Management (Initially Hidden) -->
            <div id="profile-management" class="card hidden">
                <h3 class="text-2xl font-semibold mb-6 text-gray-700">Your Profile</h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-gray-700 text-sm font-medium mb-1">Username:</label>
                        <p id="profile-username" class="text-gray-800 font-semibold"></p>
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-medium mb-1">Email:</label>
                        <p id="profile-email" class="text-gray-800 font-semibold"></p>
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-medium mb-1">Total Quizzes Taken:</label>
                        <p id="profile-quizzes-taken" class="text-gray-800 font-semibold">0</p>
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-medium mb-1">Average Score:</label>
                        <p id="profile-average-score" class="text-gray-800 font-semibold">0%</p>
                    </div>
                    <h4 class="text-xl font-semibold mt-6 mb-4 text-gray-700">Recent Scores:</h4>
                    <ul id="recent-scores-list" class="list-disc list-inside space-y-2 text-gray-700">
                        <!-- Scores will be dynamically loaded here -->
                        <li class="text-gray-500">No recent scores.</li>
                    </ul>
                </div>
                <button class="btn-secondary mt-6" id="hide-profile-btn">Back to Dashboard</button>
            </div>
        </section>

        <!-- Quiz Section (Initially Hidden) -->
        <section id="quiz-section" class="hidden space-y-6">
            <h2 class="text-3xl font-bold text-center text-gray-800 mb-6" id="quiz-title"></h2>
            <div class="flex justify-between items-center mb-6 text-gray-700 font-medium">
                <span id="question-counter">Question 1/X</span>
                <div class="flex items-center space-x-2">
                    <span id="timer">Time: 00:00</span>
                    <button id="pause-timer-btn" class="btn-secondary px-3 py-1 text-sm">Pause</button>
                    <button id="resume-timer-btn" class="btn-secondary px-3 py-1 text-sm hidden">Resume</button>
                    <button id="lifeline-50-50-btn" class="btn-secondary px-3 py-1 text-sm">50/50</button>
                </div>
            </div>

            <div class="card">
                <p class="text-xl font-semibold mb-4 text-gray-800" id="question-text"></p>
                <div id="answer-options" class="space-y-3">
                    <!-- Answer options will be dynamically loaded here -->
                </div>
                <button id="get-ai-explanation-btn" class="btn-secondary w-full mt-4 hidden">Get AI Explanation ✨</button>
                <div id="ai-explanation-spinner" class="hidden mt-2 flex items-center justify-center text-purple-600">
                    <div class="spinner mr-2"></div>
                    Getting explanation...
                </div>
            </div>

            <div class="flex justify-between mt-6">
                <button class="btn-secondary" id="prev-btn" disabled>Previous</button>
                <button class="btn-primary" id="next-btn">Next</button>
            </div>
        </section>

        <!-- Quiz Result Section (Initially Hidden) -->
        <section id="quiz-result-section" class="hidden space-y-6 text-center">
            <h2 class="text-3xl font-bold text-gray-800">Quiz Completed!</h2>
            <div class="card mx-auto max-w-md">
                <p class="text-xl font-semibold mb-4 text-gray-700">Your Score:</p>
                <p id="final-score" class="text-5xl font-extrabold text-blue-600 mb-6">0%</p>
                <p id="score-details" class="text-lg text-gray-700 mb-4"></p>
                <button class="btn-primary w-full mb-4" id="view-quiz-review-btn">View Quiz Review</button>
                <button class="btn-primary w-full" id="back-to-dashboard-from-result-btn">Back to Dashboard</button>
            </div>
        </section>

        <!-- Quiz Review Section (Initially Hidden) -->
        <section id="quiz-review-section" class="hidden space-y-6">
            <h2 class="text-3xl font-bold text-center text-gray-800 mb-6">Quiz Review</h2>
            <div id="review-questions-container" class="space-y-6">
                <!-- Reviewed questions will be dynamically loaded here -->
            </div>
            <button class="btn-primary w-full mt-6" id="back-to-dashboard-from-review-btn">Back to Dashboard</button>
        </section>


        <!-- Admin Dashboard Section (Initially Hidden) -->
        <section id="admin-dashboard-section" class="hidden space-y-8">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-3xl font-bold text-gray-800">Admin Panel</h2>
                <button class="btn-secondary" id="logout-btn-admin">Logout</button>
            </div>

            <div class="card">
                <h3 class="text-2xl font-semibold mb-6 text-gray-700">Manage Quizzes</h3>
                <button class="btn-primary mb-4" id="add-new-quiz-btn">Add New Quiz</button>

                <div id="quiz-list" class="space-y-4">
                    <!-- Existing quizzes will be listed here -->
                    <p class="text-gray-500">No quizzes to display.</p>
                </div>
            </div>

            <!-- Add/Edit Quiz Form (Initially Hidden) -->
            <div id="add-edit-quiz-form" class="card hidden">
                <h3 class="text-2xl font-semibold mb-6 text-gray-700" id="quiz-form-title">Add New Quiz</h3>
                <form class="space-y-4" id="quiz-management-form">
                    <div>
                        <label for="quiz-topic" class="block text-gray-700 text-sm font-medium mb-1">Topic</label>
                        <input type="text" id="quiz-topic" placeholder="e.g., History, Science" required>
                    </div>
                    <div>
                        <label for="quiz-difficulty" class="block text-gray-700 text-sm font-medium mb-1">Difficulty</label>
                        <select id="quiz-difficulty" required>
                            <option value="easy">Easy</option>
                            <option value="medium">Medium</option>
                            <option value="hard">Hard</option>
                        </select>
                    </div>
                    <div>
                        <label for="quiz-category" class="block text-gray-700 text-sm font-medium mb-1">Category</label>
                        <select id="quiz-category" required>
                            <option value="General Knowledge">General Knowledge</option>
                            <option value="Academic">Academic</option>
                            <option value="Fun">Fun</option>
                        </select>
                    </div>
                    <div id="questions-container" class="space-y-4 border p-4 rounded-lg bg-gray-50">
                        <h4 class="text-xl font-semibold text-gray-700">Questions</h4>
                        <!-- Dynamic question fields go here -->
                        <div class="question-item space-y-2 p-3 border rounded-lg bg-white">
                            <label for="question-text-0" class="block text-gray-700 text-sm font-medium mb-1">Question 1 Text</label>
                            <input type="text" id="question-text-0" placeholder="Enter question text" required>
                            <label class="block text-gray-700 text-sm font-medium mb-1">Options (Comma separated)</label>
                            <input type="text" id="question-options-0" placeholder="Option A, Option B, Option C" required>
                            <label for="question-correct-0" class="block text-gray-700 text-sm font-medium mb-1">Correct Option (Exact text)</label>
                            <input type="text" id="question-correct-0" placeholder="Option A" required>
                            <button type="button" class="btn-secondary text-sm mt-2" onclick="removeQuestionField(this)">Remove Question</button>
                        </div>
                    </div>
                    <button type="button" class="btn-secondary w-full" id="add-another-question-btn">Add Another Question</button>
                    <button type="submit" class="btn-primary w-full" id="save-quiz-btn">Save Quiz</button>
                    <button type="button" class="btn-secondary w-full" id="cancel-quiz-form-btn">Cancel</button>
                </form>
            </div>
        </section>
    </div>

    <script>
        // --- Global State Variables ---
        let currentUser = null; // Stores logged-in user's data { username, email, scores: [] }
        let currentQuiz = null; // Stores the active quiz data
        let currentQuestionIndex = 0;
        let userAnswers = []; // Stores user's selected answers for the current quiz
        let timerInterval = null;
        let timeLeft = 0;
        const QUIZ_DURATION_SECONDS = 300; // 5 minutes per quiz for demonstration
        let isTimerPaused = false; // New state for timer pause
        let currentQuizQuestions = []; // Store questions for review (deep copy from currentQuiz)
        let lifeline5050Used = false; // New state for 50/50 lifeline usage

        // In-memory "database" backed by localStorage
        let users = JSON.parse(localStorage.getItem('quizUsers')) || [];
        let quizzes = JSON.parse(localStorage.getItem('quizData')) || [
            {
                id: 'q1',
                topic: 'History',
                difficulty: 'easy',
                category: 'Academic', // New category field
                questions: [
                    {
                        text: 'Who was the first president of the United States?',
                        options: ['Abraham Lincoln', 'George Washington', 'Thomas Jefferson', 'John Adams'],
                        correct: 'George Washington'
                    },
                    {
                        text: 'When did World War II end?',
                        options: ['1942', '1945', '1950', '1939'],
                        correct: '1945'
                    },
                    {
                        text: 'What ancient civilization built the pyramids?',
                        options: ['Roman', 'Greek', 'Egyptian', 'Mayan'],
                        correct: 'Egyptian'
                    }
                ]
            },
            {
                id: 'q2',
                topic: 'Science',
                difficulty: 'medium',
                category: 'Academic', // New category field
                questions: [
                    {
                        text: 'What is the chemical symbol for water?',
                        options: ['O2', 'H2O', 'CO2', 'N2'],
                        correct: 'H2O'
                    },
                    {
                        text: 'What planet is known as the Red Planet?',
                        options: ['Earth', 'Mars', 'Jupiter', 'Venus'],
                        correct: 'Mars'
                    },
                    {
                        text: 'What is the powerhouse of the cell?',
                        options: ['Nucleus', 'Mitochondria', 'Ribosome', 'Cytoplasm'],
                        correct: 'Mitochondria'
                    }
                ]
            },
            {
                id: 'q3',
                topic: 'General Knowledge',
                difficulty: 'hard',
                category: 'General Knowledge', // New category field
                questions: [
                    {
                        text: 'What is the value of Pi (π) to two decimal places?',
                        options: ['3.12', '3.14', '3.16', '3.18'],
                        correct: '3.14'
                    },
                    {
                        text: 'What is the square root of 144?',
                        options: ['10', '11', '12', '13'],
                        correct: '12'
                    },
                    {
                        text: 'If a triangle has angles 30 and 60 degrees, what is the third angle?',
                        options: ['30', '60', '90', '180'],
                        correct: '90'
                    }
                ]
            }
        ];

        // --- DOM Elements ---
        const messageBoxContainer = document.getElementById('messageBoxContainer');
        const authSection = document.getElementById('auth-section');
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const forgotPasswordForm = document.getElementById('forgot-password-form');
        const loginEmailInput = document.getElementById('login-email');
        const loginPasswordInput = document.getElementById('login-password');
        const registerUsernameInput = document.getElementById('register-username');
        const registerEmailInput = document.getElementById('register-email');
        const registerPasswordInput = document.getElementById('register-password');
        const forgotEmailInput = document.getElementById('forgot-email');
        const authErrorMessage = document.getElementById('auth-error-message');

        const userDashboardSection = document.getElementById('user-dashboard-section');
        const dashboardUsername = document.getElementById('dashboard-username');
        const dashboardTotalQuizzes = document.getElementById('dashboard-total-quizzes'); // New
        const dashboardAverageScore = document.getElementById('dashboard-average-score'); // New
        const featuredQuizSection = document.getElementById('featured-quiz-section'); // New
        const featuredQuizTopic = document.getElementById('featured-quiz-topic'); // New
        const featuredQuizDetails = document.getElementById('featured-quiz-details'); // New
        const takeFeaturedQuizBtn = document.getElementById('take-featured-quiz-btn'); // New

        const profileManagement = document.getElementById('profile-management');
        const profileUsername = document.getElementById('profile-username');
        const profileEmail = document.getElementById('profile-email');
        const profileQuizzesTaken = document.getElementById('profile-quizzes-taken');
        const profileAverageScore = document.getElementById('profile-average-score');
        const recentScoresList = document.getElementById('recent-scores-list');
        const quizSelection = document.getElementById('quiz-selection');
        const quizTopicsContainer = document.getElementById('quiz-topics-container');
        const startSelectedQuizBtn = document.getElementById('start-selected-quiz-btn'); 
        const aiTopicInput = document.getElementById('ai-topic-input');
        const aiNumQuestionsInput = document.getElementById('ai-num-questions-input'); // New
        const aiDifficultySelect = document.getElementById('ai-difficulty-select'); // New
        const generateAiQuizBtn = document.getElementById('generate-ai-quiz-btn');
        const aiLoadingSpinner = document.getElementById('ai-loading-spinner');
        const aiGenerationErrorMessage = document.getElementById('ai-generation-error-message');
        const quizSearchInput = document.getElementById('quiz-search-input'); // New search input
        const quizCategoryFilter = document.getElementById('quiz-category-filter'); // New category filter

        const quizSection = document.getElementById('quiz-section');
        const quizTitle = document.getElementById('quiz-title');
        const questionCounter = document.getElementById('question-counter');
        const timerDisplay = document.getElementById('timer');
        const pauseTimerBtn = document.getElementById('pause-timer-btn'); // New timer buttons
        const resumeTimerBtn = document.getElementById('resume-timer-btn'); // New timer buttons
        const lifeline5050Btn = document.getElementById('lifeline-50-50-btn'); // New 50/50 lifeline button
        const questionText = document.getElementById('question-text');
        const answerOptionsContainer = document.getElementById('answer-options');
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn'); 
        const getAiExplanationBtn = document.getElementById('get-ai-explanation-btn'); 
        const aiExplanationSpinner = document.getElementById('ai-explanation-spinner'); 

        const quizResultSection = document.getElementById('quiz-result-section');
        const finalScoreDisplay = document.getElementById('final-score');
        const scoreDetails = document.getElementById('score-details');
        const viewQuizReviewBtn = document.getElementById('view-quiz-review-btn'); // New review button
        const quizReviewSection = document.getElementById('quiz-review-section'); // New review section
        const reviewQuestionsContainer = document.getElementById('review-questions-container'); // Container for review questions

        const adminDashboardSection = document.getElementById('admin-dashboard-section');
        const addEditQuizForm = document.getElementById('add-edit-quiz-form');
        const quizFormTitle = document.getElementById('quiz-form-title');
        const quizTopicInput = document.getElementById('quiz-topic');
        const quizDifficultySelect = document.getElementById('quiz-difficulty');
        const quizCategorySelect = document.getElementById('quiz-category'); // New
        const questionsContainer = document.getElementById('questions-container');
        const quizList = document.getElementById('quiz-list');
        const leaderboardSection = document.getElementById('leaderboard-section'); // New leaderboard section
        const leaderboardList = document.getElementById('leaderboard-list'); // New leaderboard list


        // --- Utility Functions ---

        /**
         * Shows a custom message box instead of alert().
         * @param {string} message - The message to display.
         * @param {function} [onClose] - Callback function when the box is closed.
         */
        function showMessageBox(message, onClose = null) {
            if (!messageBoxContainer) return;

            messageBoxContainer.innerHTML = ''; // Clear any existing message box

            const overlay = document.createElement('div');
            overlay.className = 'overlay';
            overlay.id = 'messageBoxOverlay';

            const messageBox = document.createElement('div');
            messageBox.className = 'message-box';
            messageBox.innerHTML = `
                <p class="text-lg text-gray-800">${message}</p>
                <button id="messageBoxCloseBtn" class="btn-primary">OK</button>
            `;

            messageBoxContainer.appendChild(overlay);
            messageBoxContainer.appendChild(messageBox);

            document.getElementById('messageBoxCloseBtn').onclick = () => {
                messageBoxContainer.innerHTML = ''; // Clear message box and overlay
                if (onClose) {
                    onClose();
                }
            };
        }

        /**
         * Hides all main sections.
         */
        function hideAllSections() {
            [authSection, userDashboardSection, quizSection, quizResultSection, adminDashboardSection, quizReviewSection].forEach(section => {
                section.classList.add('hidden');
            });
            if (authErrorMessage) authErrorMessage.classList.add('hidden'); // Clear auth errors on screen change
            if (aiGenerationErrorMessage) aiGenerationErrorMessage.classList.add('hidden'); // Clear AI errors on screen change
        }

        /**
         * Displays the login form and hides others.
         */
        function showLoginForm() {
            loginForm.classList.remove('hidden');
            registerForm.classList.add('hidden');
            forgotPasswordForm.classList.add('hidden');
            if (authErrorMessage) authErrorMessage.classList.add('hidden'); // Clear previous errors
        }

        /**
         * Displays the registration form and hides others.
         */
        function showRegisterForm() {
            loginForm.classList.add('hidden');
            registerForm.classList.remove('hidden');
            forgotPasswordForm.classList.add('hidden');
            if (authErrorMessage) authErrorMessage.classList.add('hidden'); // Clear previous errors
        }

        /**
         * Displays the forgot password form and hides others.
         */
        function showForgotPasswordForm() {
            loginForm.classList.add('hidden');
            registerForm.classList.add('hidden');
            forgotPasswordForm.classList.remove('hidden');
            if (authErrorMessage) authErrorMessage.classList.add('hidden'); // Clear previous errors
        }

        /**
         * Displays the authentication section.
         */
        function showAuthSection() {
            hideAllSections();
            authSection.classList.remove('hidden');
            showLoginForm(); // Default to login form
        }

        /**
         * Displays the user dashboard section.
         */
        function showUserDashboard() {
            hideAllSections();
            userDashboardSection.classList.remove('hidden');
            profileManagement.classList.add('hidden');
            quizSelection.classList.remove('hidden');
            leaderboardSection.classList.remove('hidden'); // Show leaderboard on dashboard
            featuredQuizSection.classList.remove('hidden'); // Show featured quiz on dashboard
            updateDashboardUI();
            loadQuizTopics();
            loadLeaderboard(); // Load leaderboard data
            loadFeaturedQuiz(); // Load featured quiz
        }

        /**
         * Displays the quiz section.
         */
        function showQuizSection() {
            hideAllSections();
            quizSection.classList.remove('hidden');
            // Reset timer buttons visibility
            pauseTimerBtn.classList.remove('hidden');
            resumeTimerBtn.classList.add('hidden');
            isTimerPaused = false;
        }

        /**
         * Displays the quiz result section.
         */
        function showQuizResultSection() {
            hideAllSections();
            quizResultSection.classList.remove('hidden');
        }

        /**
         * Displays the quiz review section.
         * @param {object} quizData - The quiz data (questions) for review.
         * @param {Array} answersData - The user's answers for review.
         */
        function showQuizReviewSection(quizData, answersData) {
            hideAllSections();
            quizReviewSection.classList.remove('hidden');
            displayQuizReview(quizData, answersData);
        }

        /**
         * Displays the admin dashboard section.
         */
        function showAdminDashboard() {
            hideAllSections();
            adminDashboardSection.classList.remove('hidden');
            addEditQuizForm.classList.add('hidden');
            quizList.classList.remove('hidden'); // Ensure quiz list is visible when entering admin
            loadAdminQuizList();
        }

        /**
         * Displays the profile management section.
         */
        function showProfile() {
            quizSelection.classList.add('hidden');
            leaderboardSection.classList.add('hidden'); // Hide leaderboard when viewing profile
            featuredQuizSection.classList.add('hidden'); // Hide featured quiz when viewing profile
            profileManagement.classList.remove('hidden');
            updateProfileUI();
        }

        /**
         * Hides the profile management section.
         */
        function hideProfile() {
            profileManagement.classList.add('hidden');
            quizSelection.classList.remove('hidden');
            leaderboardSection.classList.remove('hidden'); // Show leaderboard again
            featuredQuizSection.classList.remove('hidden'); // Show featured quiz again
        }

        /**
         * Shows the quiz selection section.
         */
        function showQuizSelection() {
            profileManagement.classList.add('hidden');
            quizSelection.classList.remove('hidden');
            leaderboardSection.classList.remove('hidden'); // Show leaderboard again
            featuredQuizSection.classList.remove('hidden'); // Show featured quiz again
            loadQuizTopics();
            quizSearchInput.value = ''; // Clear search input when showing quiz selection
            quizCategoryFilter.value = ''; // Reset category filter
        }

        /**
         * Shows the add/edit quiz form.
         * @param {object} [quizToEdit] - Optional quiz object to pre-fill the form for editing.
         */
        function showAddQuizForm(quizToEdit = null) {
            addEditQuizForm.classList.remove('hidden');
            quizList.classList.add('hidden'); // Hide quiz list when form is open

            quizFormTitle.textContent = quizToEdit ? 'Edit Quiz' : 'Add New Quiz';
            quizTopicInput.value = quizToEdit ? quizToEdit.topic : '';
            quizDifficultySelect.value = quizToEdit ? quizToEdit.difficulty : 'easy';
            quizCategorySelect.value = quizToEdit ? quizToEdit.category : 'General Knowledge'; // Set category
            addEditQuizForm.dataset.editingId = quizToEdit ? quizToEdit.id : ''; // Store ID for saving

            questionsContainer.innerHTML = '<h4 class="text-xl font-semibold text-gray-700">Questions</h4>'; // Clear previous questions
            if (quizToEdit && quizToEdit.questions && quizToEdit.questions.length > 0) {
                quizToEdit.questions.forEach((q, index) => addQuestionField(q, index));
            } else {
                addQuestionField(); // Add one empty question field by default
            }
        }

        /**
         * Hides the add/edit quiz form.
         */
        function hideAddEditQuizForm() {
            addEditQuizForm.classList.add('hidden');
            quizList.classList.remove('hidden');
            loadAdminQuizList(); // Reload the list to reflect any changes
        }

        /**
         * Adds a new question field to the add/edit quiz form.
         * @param {object} [questionData] - Optional question object to pre-fill the fields.
         * @param {number} [index] - Optional index for unique IDs.
         */
        function addQuestionField(questionData = null, index = null) {
            const currentQuestionCount = questionsContainer.querySelectorAll('.question-item').length;
            const newIndex = index !== null ? index : currentQuestionCount;

            const questionItem = document.createElement('div');
            questionItem.className = 'question-item space-y-2 p-3 border rounded-lg bg-white shadow-sm';
            questionItem.innerHTML = `
                <label for="question-text-${newIndex}" class="block text-gray-700 text-sm font-medium mb-1">Question ${newIndex + 1} Text</label>
                <input type="text" id="question-text-${newIndex}" placeholder="Enter question text" value="${questionData ? questionData.text : ''}" required>
                <label class="block text-gray-700 text-sm font-medium mb-1">Options (Comma separated)</label>
                <input type="text" id="question-options-${newIndex}" placeholder="Option A, Option B, Option C" required>
                <label for="question-correct-${newIndex}" class="block text-gray-700 text-sm font-medium mb-1">Correct Option (Exact text)</label>
                <input type="text" id="question-correct-${newIndex}" placeholder="Option A" value="${questionData ? questionData.correct : ''}" required>
                <button type="button" class="btn-secondary text-sm mt-2" onclick="removeQuestionField(this)">Remove Question</button>
            `;
            questionsContainer.appendChild(questionItem);

            // Attach event listener for the remove button
            questionItem.querySelector('.remove-question-btn').addEventListener('click', (event) => {
                removeQuestionField(event.target);
            });

            // Update question numbers for all fields
            questionsContainer.querySelectorAll('.question-item').forEach((item, idx) => {
                item.querySelector('label[for^="question-text"]').textContent = `Question ${idx + 1} Text`;
                item.querySelector('input[id^="question-text"]').id = `question-text-${idx}`;
                item.querySelector('input[id^="question-options"]').id = `question-options-${idx}`;
                item.querySelector('input[id^="question-correct"]').id = `question-correct-${idx}`;
                item.querySelector('.remove-question-btn').dataset.index = idx; // Update data-index for removal
            });
        }

        /**
         * Removes a question field from the add/edit quiz form.
         * @param {HTMLElement} button - The remove button element.
         */
        function removeQuestionField(button) {
            const questionItem = button.closest('.question-item');
            questionItem.remove();

            // Re-index remaining questions
            document.getElementById('questions-container').querySelectorAll('.question-item').forEach((item, idx) => {
                item.querySelector('label[for^="question-text"]').textContent = `Question ${idx + 1} Text`;
                item.querySelector('input[id^="question-text"]').id = `question-text-${idx}`;
                item.querySelector('input[id^="question-options"]').id = `question-options-${idx}`;
                item.querySelector('input[id^="question-correct"]').id = `question-correct-${idx}`;
                item.querySelector('.remove-question-btn').dataset.index = idx;
            });
        }

        // --- Authentication Functions ---

        /**
         * Handles user login.
         * @param {Event} event - The form submission event.
         */
        function handleLogin(event) {
            event.preventDefault();
            const email = loginEmailInput.value;
            const password = loginPasswordInput.value;
            if (authErrorMessage) authErrorMessage.classList.add('hidden');

            const user = users.find(u => u.email === email && u.password === password);

            if (user) {
                currentUser = user;
                localStorage.setItem('currentUser', JSON.stringify(currentUser)); // Persist login
                showMessageBox(`Welcome back, ${currentUser.username}!`, () => {
                    if (currentUser.role === 'admin') {
                        showAdminDashboard();
                    } else {
                        showUserDashboard();
                    }
                });
            } else {
                if (authErrorMessage) {
                    authErrorMessage.textContent = 'Invalid email or password. Please try again.';
                    authErrorMessage.classList.remove('hidden');
                } else {
                    showMessageBox('Invalid email or password. Please try again.');
                }
            }
        }

        /**
         * Handles user registration.
         * @param {Event} event - The form submission event.
         */
        function handleRegister(event) {
            event.preventDefault();
            const username = registerUsernameInput.value.trim();
            const email = registerEmailInput.value.trim();
            const password = registerPasswordInput.value.trim();
            if (authErrorMessage) authErrorMessage.classList.add('hidden');

            if (!username || !email || !password) {
                if (authErrorMessage) {
                    authErrorMessage.textContent = "Please fill in all fields.";
                    authErrorMessage.classList.remove('hidden');
                } else {
                    showMessageBox("Please fill in all fields.");
                }
                return;
            }

            if (users.some(u => u.email === email)) {
                if (authErrorMessage) {
                    authErrorMessage.textContent = 'An account with this email already exists.';
                    authErrorMessage.classList.remove('hidden');
                } else {
                    showMessageBox('An account with this email already exists.');
                }
                return;
            }

            const newUser = {
                username,
                email,
                password,
                role: 'student', // Default role
                scores: [] // Array to store quiz scores
            };
            users.push(newUser);
            localStorage.setItem('quizUsers', JSON.stringify(users));
            currentUser = newUser; // Log in the new user immediately
            localStorage.setItem('currentUser', JSON.stringify(currentUser)); // Persist login

            showMessageBox('Registration successful! You are now logged in.', () => {
                showUserDashboard();
            });
        }

        /**
         * Handles password recovery.
         * @param {Event} event - The form submission event.
         */
        function handleForgotPassword(event) {
            event.preventDefault();
            const email = forgotEmailInput.value.trim();
            if (authErrorMessage) authErrorMessage.classList.add('hidden');

            if (!email) {
                 if (authErrorMessage) {
                    authErrorMessage.textContent = "Please enter your email.";
                    authErrorMessage.classList.remove('hidden');
                } else {
                    showMessageBox("Please enter your email.");
                }
                return;
            }

            const user = users.find(u => u.email === email);
            if (user) {
                // In a real app, this would send a password reset email.
                // For this demo, we'll just simulate a success message.
                showMessageBox(`If an account with ${email} exists, a password reset link has been sent.`, () => {
                    showLoginForm();
                });
            } else {
                if (authErrorMessage) {
                    authErrorMessage.textContent = 'No account found with that email address.';
                    authErrorMessage.classList.remove('hidden');
                } else {
                    showMessageBox('No account found with that email address.');
                }
            }
        }

        /**
         * Logs out the current user and returns to the authentication section.
         */
        function logout() {
            currentUser = null;
            currentQuiz = null;
            currentQuestionIndex = 0;
            userAnswers = [];
            clearInterval(timerInterval);
            localStorage.removeItem('currentUser'); // Clear persisted login
            showMessageBox('You have been logged out.', () => {
                showAuthSection();
            });
        }

        // --- User Dashboard Functions ---

        /**
         * Updates the user dashboard UI with current user data.
         */
        function updateDashboardUI() {
            if (currentUser) {
                if (dashboardUsername) dashboardUsername.textContent = currentUser.username;
                
                // Update dashboard stats
                const totalQuizzesTaken = currentUser.scores ? currentUser.scores.length : 0;
                const totalScoreSum = currentUser.scores ? currentUser.scores.reduce((sum, s) => sum + s.score, 0) : 0;
                const averageScore = totalQuizzesTaken > 0 ? (totalScoreSum / totalQuizzesTaken).toFixed(2) : 0;

                if (dashboardTotalQuizzes) dashboardTotalQuizzes.textContent = totalQuizzesTaken;
                if (dashboardAverageScore) dashboardAverageScore.textContent = `${averageScore}%`;
            }
        }

        /**
         * Updates the profile UI with current user data.
         */
        function updateProfileUI() {
            if (currentUser) {
                if (profileUsername) profileUsername.textContent = currentUser.username;
                if (profileEmail) profileEmail.textContent = currentUser.email;
                if (profileQuizzesTaken) profileQuizzesTaken.textContent = currentUser.scores.length;

                const totalScoreSum = currentUser.scores.reduce((sum, s) => sum + s.score, 0);
                const averageScore = currentUser.scores.length > 0 ? (totalScoreSum / currentUser.scores.length).toFixed(2) : 0;
                if (profileAverageScore) profileAverageScore.textContent = `${averageScore}%`;

                if (recentScoresList) {
                    recentScoresList.innerHTML = '';
                    if (currentUser.scores.length > 0) {
                        // Sort by date, newest first
                        const sortedScores = [...currentUser.scores].sort((a, b) => new Date(b.date) - new Date(a.date));
                        sortedScores.slice(0, 5).forEach((score, index) => { // Show up to 5 recent scores
                            const listItem = document.createElement('li');
                            listItem.className = 'cursor-pointer hover:text-blue-600 hover:underline';
                            listItem.textContent = `${score.topic} (${score.difficulty}): ${score.score}% on ${new Date(score.date).toLocaleDateString()}`;
                            listItem.dataset.scoreIndex = index; // Store index to retrieve full quiz data
                            listItem.addEventListener('click', (event) => {
                                const scoreIdx = parseInt(event.target.dataset.scoreIndex);
                                const historicalQuizResult = sortedScores[scoreIdx]; // Get the full historical result
                                showQuizReviewSection(historicalQuizResult.questions, historicalQuizResult.userAnswers);
                            });
                            recentScoresList.appendChild(listItem);
                        });
                    } else {
                        const listItem = document.createElement('li');
                        listItem.className = 'text-gray-500';
                        listItem.textContent = 'No recent scores.';
                        recentScoresList.appendChild(listItem);
                    }
                }
            }
        }

        /**
         * Loads available quiz topics into the dashboard, optionally filtering them.
         * @param {string} [searchTerm=''] - Optional search term to filter quizzes by topic.
         * @param {string} [categoryFilter=''] - Optional category to filter quizzes by.
         */
        function loadQuizTopics(searchTerm = '', categoryFilter = '') {
            quizTopicsContainer.innerHTML = ''; // Clear previous topics
            let filteredQuizzes = quizzes;

            if (searchTerm) {
                const lowerCaseSearchTerm = searchTerm.toLowerCase();
                filteredQuizzes = filteredQuizzes.filter(quiz =>
                    quiz.topic.toLowerCase().includes(lowerCaseSearchTerm)
                );
            }

            if (categoryFilter) {
                filteredQuizzes = filteredQuizzes.filter(quiz =>
                    quiz.category === categoryFilter
                );
            }

            if (filteredQuizzes.length === 0) {
                quizTopicsContainer.innerHTML = '<p class="text-center text-gray-500 col-span-full">No quizzes found matching your criteria. Please try a different search or filter.</p>';
                startSelectedQuizBtn.classList.add('hidden');
                return;
            }

            filteredQuizzes.forEach(quiz => {
                const topicCard = document.createElement('div');
                topicCard.className = 'quiz-option flex-col items-start'; // Use flex-col for better layout
                topicCard.dataset.quizId = quiz.id; // Store quiz ID for selection
                topicCard.innerHTML = `
                    <input type="radio" name="quizTopic" id="quiz-${quiz.id}" value="${quiz.id}" class="hidden">
                    <label for="quiz-${quiz.id}" class="flex-grow cursor-pointer w-full">
                        <span class="block font-semibold text-lg text-gray-800">${quiz.topic}</span>
                        <span class="block text-sm text-gray-600 capitalize">Difficulty: ${quiz.difficulty}</span>
                        <span class="block text-xs text-gray-500">Category: ${quiz.category || 'N/A'}</span>
                        <span class="block text-xs text-gray-500">${quiz.questions.length} Questions</span>
                    </label>
                    <button class="btn-secondary text-xs mt-2 self-end learn-more-topic-btn" data-topic="${quiz.topic}">Learn More ✨</button>
                `;
                topicCard.addEventListener('click', (event) => {
                     // Only select the card if the click wasn't on the "Learn More" button
                    if (!event.target.classList.contains('learn-more-topic-btn')) {
                        document.querySelectorAll('.quiz-option').forEach(card => card.classList.remove('selected'));
                        topicCard.classList.add('selected');
                        currentQuiz = quizzes.find(q => q.id === quiz.id); // Set the selected quiz
                        startSelectedQuizBtn.classList.remove('hidden');
                    }
                });
                quizTopicsContainer.appendChild(topicCard);
            });

            // Attach event listeners for "Learn More" buttons
            document.querySelectorAll('.learn-more-topic-btn').forEach(button => {
                button.addEventListener('click', (event) => {
                    event.stopPropagation(); // Prevent card selection when clicking "Learn More"
                    const topic = event.target.dataset.topic;
                    getTopicOverviewWithAI(topic);
                });
            });

            // Ensure start button visibility is correct based on whether a quiz is selected
            if (!currentQuiz || !filteredQuizzes.some(q => q.id === currentQuiz.id)) {
                startSelectedQuizBtn.classList.add('hidden');
            } else {
                startSelectedQuizBtn.classList.remove('hidden');
            }
        }

        /**
         * Loads a random featured quiz onto the dashboard.
         */
        function loadFeaturedQuiz() {
            const availableQuizzes = quizzes.filter(q => q.category !== 'AI Generated'); // Don't feature AI generated quizzes
            if (availableQuizzes.length > 0) {
                const randomIndex = Math.floor(Math.random() * availableQuizzes.length);
                const featured = availableQuizzes[randomIndex];
                featuredQuizTopic.textContent = featured.topic;
                featuredQuizDetails.textContent = `Category: ${featured.category} | Difficulty: ${featured.difficulty} | Questions: ${featured.questions.length}`;
                featuredQuizSection.classList.remove('hidden');
                takeFeaturedQuizBtn.onclick = () => {
                    currentQuiz = featured; // Set the featured quiz as current
                    startQuiz();
                };
            } else {
                featuredQuizSection.classList.add('hidden'); // Hide if no quizzes available
            }
        }


        /**
         * Starts a quiz based on the selected quiz ID.
         */
        function startQuiz() {
            if (!currentQuiz) {
                showMessageBox('Please select a quiz topic first.');
                return;
            }

            currentQuestionIndex = 0;
            userAnswers = Array(currentQuiz.questions.length).fill(null); // Initialize user answers
            timeLeft = QUIZ_DURATION_SECONDS;
            currentQuizQuestions = JSON.parse(JSON.stringify(currentQuiz.questions)); // Deep copy for review
            lifeline5050Used = false; // Reset lifeline usage for new quiz
            lifeline5050Btn.disabled = false; // Enable 50/50 button

            quizTitle.textContent = `${currentQuiz.topic} Quiz`;
            showQuizSection();
            displayQuestion();
            startTimer();
        }

        // --- Quiz Functions ---

        /**
         * Applies the 50/50 lifeline.
         */
        function use5050Lifeline() {
            if (lifeline5050Used) {
                showMessageBox("You've already used your 50/50 lifeline for this quiz.");
                return;
            }

            const currentQuestion = currentQuiz.questions[currentQuestionIndex];
            const options = Array.from(answerOptionsContainer.children); // Get all option divs
            const correctOptionDiv = options.find(opt => opt.dataset.option === currentQuestion.correct);

            // Find incorrect options
            const incorrectOptions = options.filter(opt => opt.dataset.option !== currentQuestion.correct);

            if (incorrectOptions.length >= 2) {
                // Randomly select two incorrect options to hide
                const optionsToHide = [];
                while (optionsToHide.length < 2) {
                    const randomIndex = Math.floor(Math.random() * incorrectOptions.length);
                    const optionToHide = incorrectOptions[randomIndex];
                    if (!optionsToHide.includes(optionToHide)) {
                        optionsToHide.push(optionToHide);
                    }
                }

                optionsToHide.forEach(optDiv => {
                    optDiv.classList.add('hidden'); // Hide the option
                    optDiv.style.pointerEvents = 'none'; // Make it unclickable
                });

                lifeline5050Used = true;
                lifeline5050Btn.disabled = true; // Disable button after use
                showMessageBox("Two incorrect options have been removed!");
            } else {
                showMessageBox("50/50 can't be used, not enough incorrect options to remove.");
            }
        }


        /**
         * Displays the current question and its options.
         */
        function displayQuestion() {
            if (!currentQuiz || currentQuestionIndex >= currentQuiz.questions.length) {
                submitQuiz();
                return;
            }

            const question = currentQuiz.questions[currentQuestionIndex];
            questionCounter.textContent = `Question ${currentQuestionIndex + 1}/${currentQuiz.questions.length}`;
            questionText.textContent = question.text;

            answerOptionsContainer.innerHTML = ''; // Clear previous options
            getAiExplanationBtn.classList.add('hidden'); // Hide AI explanation button by default
            aiExplanationSpinner.classList.add('hidden'); // Hide AI explanation spinner
            lifeline5050Btn.disabled = lifeline5050Used; // Update 50/50 button state

            question.options.forEach((option, index) => {
                const optionDiv = document.createElement('div');
                optionDiv.className = 'quiz-option';
                optionDiv.dataset.option = option; // Add data-option for easy lookup
                optionDiv.innerHTML = `
                    <input type="radio" name="answer" id="option-${index}" value="${option}" class="hidden">
                    <label for="option-${index}" class="flex-grow cursor-pointer text-gray-700">
                        <span class="font-bold mr-2">${String.fromCharCode(65 + index)}.</span> ${option}
                    </label>
                `;
                optionDiv.addEventListener('click', () => selectAnswer(option));
                answerOptionsContainer.appendChild(optionDiv);
            });

            // Highlight previously selected answer if any and apply feedback
            if (userAnswers[currentQuestionIndex] !== null) {
                const selectedOptionValue = userAnswers[currentQuestionIndex];
                const selectedOptionDiv = answerOptionsContainer.querySelector(`.quiz-option[data-option="${selectedOptionValue}"]`);
                if (selectedOptionDiv) {
                    selectedOptionDiv.classList.add('selected');
                    const radio = selectedOptionDiv.querySelector('input[type="radio"]');
                    if (radio) radio.checked = true;
                }
                updateAnswerFeedback(); // Apply correct/incorrect styling
            } else {
                // Re-enable clicks if no answer is selected yet for this question
                answerOptionsContainer.querySelectorAll('.quiz-option').forEach(optionDiv => {
                    optionDiv.style.pointerEvents = 'auto';
                });
            }

            // Update navigation buttons
            prevBtn.disabled = currentQuestionIndex === 0;
            nextBtn.textContent = currentQuestionIndex === currentQuiz.questions.length - 1 ? 'Submit Quiz' : 'Next';
        }

        /**
         * Selects an answer for the current question.
         * @param {string} selectedOption - The text of the selected option.
         */
        function selectAnswer(selectedOption) {
            userAnswers[currentQuestionIndex] = selectedOption;
            // Visually update selection
            document.querySelectorAll('.quiz-option').forEach(optionDiv => {
                optionDiv.classList.remove('selected', 'correct', 'incorrect'); // Clear all feedback first
                optionDiv.style.pointerEvents = 'none'; // Disable clicks after selection
                const radio = optionDiv.querySelector('input[type="radio"]');
                if (radio) radio.checked = false; // Uncheck all radios
            });

            const selectedOptionDiv = answerOptionsContainer.querySelector(`.quiz-option[data-option="${selectedOption}"]`);
            if (selectedOptionDiv) {
                selectedOptionDiv.classList.add('selected'); // Apply selected style
                const radio = selectedOptionDiv.querySelector('input[type="radio"]');
                if (radio) radio.checked = true; // Check the selected radio
            }
            updateAnswerFeedback(); // Apply correct/incorrect styling
        }

        /**
         * Updates the visual feedback for the selected answer (correct/incorrect).
         */
        function updateAnswerFeedback() {
            const currentQuestion = currentQuiz.questions[currentQuestionIndex];
            const selectedAnswer = userAnswers[currentQuestionIndex];

            answerOptionsContainer.querySelectorAll('.quiz-option').forEach(optionDiv => {
                // Keep 'selected' class if it was applied by selectAnswer, then add correct/incorrect
                // optionDiv.classList.remove('correct', 'incorrect'); // This line was problematic, removed it from here

                if (selectedAnswer !== null) { // If an answer has been selected for this question
                    optionDiv.style.pointerEvents = 'none'; // Disable clicks after selection

                    if (optionDiv.dataset.option === currentQuestion.correct) {
                        optionDiv.classList.add('correct');
                    } else if (optionDiv.dataset.option === selectedAnswer) {
                        optionDiv.classList.add('incorrect');
                    }
                }
            });

            // Show/hide AI explanation button based on correctness
            if (selectedAnswer !== null && selectedAnswer !== currentQuestion.correct) {
                getAiExplanationBtn.classList.remove('hidden');
            } else {
                getAiExplanationBtn.classList.add('hidden');
            }
        }

        /**
         * Moves to the previous question.
         */
        function prevQuestion() {
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                displayQuestion();
            }
        }

        /**
         * Moves to the next question or submits the quiz if it's the last question.
         */
        function nextQuestion() {
            if (currentQuestionIndex < currentQuiz.questions.length - 1) {
                currentQuestionIndex++;
                displayQuestion();
            } else {
                submitQuiz();
            }
        }

        /**
         * Starts the quiz timer.
         */
        function startTimer() {
            clearInterval(timerInterval); // Clear any existing timer
            if (isTimerPaused) return; // Don't start if paused

            timerInterval = setInterval(() => {
                timeLeft--;
                const minutes = Math.floor(timeLeft / 60);
                const seconds = timeLeft % 60;
                timerDisplay.textContent = `Time: ${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;

                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    showMessageBox('Time is up! Submitting your quiz.', submitQuiz);
                }
            }, 1000);
        }

        /**
         * Pauses the quiz timer.
         */
        function pauseTimer() {
            clearInterval(timerInterval);
            isTimerPaused = true;
            pauseTimerBtn.classList.add('hidden');
            resumeTimerBtn.classList.remove('hidden');
        }

        /**
         * Resumes the quiz timer.
         */
        function resumeTimer() {
            isTimerPaused = false;
            startTimer();
            pauseTimerBtn.classList.remove('hidden');
            resumeTimerBtn.classList.add('hidden');
        }

        /**
         * Submits the quiz, calculates the score, and displays results.
         */
        function submitQuiz() {
            clearInterval(timerInterval); // Stop the timer
            let correctAnswersCount = 0;

            currentQuiz.questions.forEach((question, index) => {
                if (userAnswers[index] === question.correct) {
                    correctAnswersCount++;
                }
            });

            const totalQuestions = currentQuiz.questions.length;
            const score = (correctAnswersCount / totalQuestions) * 100;

            // Store score in current user's data
            if (currentUser) {
                // Ensure currentUser.scores is an array
                if (!currentUser.scores) {
                    currentUser.scores = [];
                }
                currentUser.scores.push({
                    quizId: currentQuiz.id,
                    topic: currentQuiz.topic,
                    difficulty: currentQuiz.difficulty,
                    category: currentQuiz.category || 'N/A', // Store category
                    score: parseFloat(score.toFixed(2)),
                    date: new Date().toISOString(),
                    userAnswers: userAnswers, // Store user's answers for review
                    questions: currentQuiz.questions // Store questions for review
                });
                localStorage.setItem('quizUsers', JSON.stringify(users)); // Update local storage
                localStorage.setItem('currentUser', JSON.stringify(currentUser)); // Update current user in local storage
            }

            finalScoreDisplay.textContent = `${score.toFixed(2)}%`;
            scoreDetails.textContent = `You answered ${correctAnswersCount} out of ${totalQuestions} questions correctly.`;
            showQuizResultSection();
        }

        /**
         * Displays the quiz review after completion or for a past quiz.
         * @param {object} quizData - The quiz data (questions) for review.
         * @param {Array} answersData - The user's answers for review.
         */
        function displayQuizReview(quizData, answersData) {
            reviewQuestionsContainer.innerHTML = ''; // Clear previous review

            quizData.forEach((question, index) => {
                const userAnswer = answersData[index];
                const isCorrect = userAnswer === question.correct;

                const reviewItem = document.createElement('div');
                reviewItem.classList.add('card', 'mb-4', isCorrect ? 'border-green-300' : 'border-red-300');
                reviewItem.innerHTML = `
                    <p class="font-semibold text-lg text-gray-800 mb-2">Question ${index + 1}: ${question.text}</p>
                    <p class="text-sm text-gray-700 mb-1">Your Answer: <span class="${isCorrect ? 'text-green-600' : 'text-red-600'} font-medium">${userAnswer || 'Not Answered'}</span></p>
                    <p class="text-sm text-gray-700 mb-2">Correct Answer: <span class="text-slate-600 font-medium">${question.correct}</span></p>
                    ${!isCorrect ? `<button class="btn-secondary text-sm mt-2 get-review-explanation-btn" data-question-index="${index}">View Explanation ✨</button>` : ''}
                `;
                reviewQuestionsContainer.appendChild(reviewItem);
            });

            // Attach event listeners for "View Explanation" buttons in review
            document.querySelectorAll('.get-review-explanation-btn').forEach(button => {
                button.addEventListener('click', (event) => {
                    const qIndex = parseInt(event.target.dataset.questionIndex);
                    const question = quizData[qIndex]; // Use quizData passed to this function
                    const selectedAnswer = answersData[qIndex]; // Use answersData passed to this function
                    getAiExplanationForReview(question.text, question.correct, selectedAnswer);
                });
            });
        }

        // --- Admin Functions ---

        /**
         * Loads and displays the list of quizzes in the admin panel.
         */
        function loadAdminQuizList() {
            const quizListContainer = document.getElementById('quiz-list');
            quizListContainer.innerHTML = ''; // Clear existing list

            if (quizzes.length === 0) {
                quizListContainer.innerHTML = '<p class="text-gray-500">No quizzes to display. Click "Add New Quiz" to create one.</p>';
                return;
            }

            quizzes.forEach(quiz => {
                const quizItem = document.createElement('div');
                quizItem.className = 'card flex justify-between items-center mb-4';
                quizItem.innerHTML = `
                    <div>
                        <p class="font-semibold text-lg text-gray-800">${quiz.topic} (<span class="capitalize">${quiz.difficulty}</span>)</p>
                        <p class="text-sm text-gray-600">Category: ${quiz.category || 'N/A'}</p>
                        <p class="text-sm text-gray-600">${quiz.questions.length} Questions</p>
                    </div>
                    <div class="space-x-2">
                        <button class="btn-secondary text-sm edit-quiz-btn" data-quiz-id="${quiz.id}">Edit</button>
                        <button class="bg-red-500 text-white px-3 py-1 rounded-lg hover:bg-red-600 transition duration-300 ease-in-out text-sm delete-quiz-btn" data-quiz-id="${quiz.id}">Delete</button>
                    </div>
                `;
                quizListContainer.appendChild(quizItem);
            });

            // Attach event listeners for edit and delete buttons
            document.querySelectorAll('.edit-quiz-btn').forEach(button => {
                button.addEventListener('click', (event) => {
                    const quizId = event.target.dataset.quizId;
                    editQuiz(quizId);
                });
            });
            document.querySelectorAll('.delete-quiz-btn').forEach(button => {
                button.addEventListener('click', (event) => {
                    const quizId = event.target.dataset.quizId;
                    deleteQuiz(quizId);
                });
            });
        }

        /**
         * Saves a new or edited quiz.
         * @param {Event} event - The form submission event.
         */
        function saveQuiz(event) {
            event.preventDefault();

            const quizTopic = quizTopicInput.value.trim();
            const quizDifficulty = quizDifficultySelect.value;
            const quizCategory = quizCategorySelect.value; // Get category
            const questionItems = questionsContainer.querySelectorAll('.question-item');

            if (!quizTopic) {
                showMessageBox('Quiz topic cannot be empty.');
                return;
            }
            if (questionItems.length === 0) {
                showMessageBox('A quiz must have at least one question.');
                return;
            }

            const newQuestions = [];
            let allQuestionsValid = true;
            questionItems.forEach((item, index) => {
                const questionText = item.querySelector(`input[id="question-text-${index}"]`).value.trim();
                const optionsText = item.querySelector(`input[id="question-options-${index}"]`).value.trim();
                const correctOption = item.querySelector(`input[id="question-correct-${index}"]`).value.trim();

                if (!questionText || !optionsText || !correctOption) {
                    showMessageBox(`Question ${index + 1}: All fields must be filled.`);
                    allQuestionsValid = false;
                    return;
                }

                const options = optionsText.split(',').map(opt => opt.trim());
                if (!options.includes(correctOption)) {
                    showMessageBox(`Question ${index + 1}: Correct option must be one of the provided options.`);
                    allQuestionsValid = false;
                    return;
                }

                newQuestions.push({
                    text: questionText,
                    options: options,
                    correct: correctOption
                });
            });

            if (!allQuestionsValid) {
                return;
            }

            // Check if we are editing an existing quiz or adding a new one
            const editingId = addEditQuizForm.dataset.editingId;
            if (editingId) {
                // Editing existing quiz
                const quizIndex = quizzes.findIndex(q => q.id === editingId);
                if (quizIndex !== -1) {
                    quizzes[quizIndex].topic = quizTopic;
                    quizzes[quizIndex].difficulty = quizDifficulty;
                    quizzes[quizIndex].category = quizCategory; // Update category
                    quizzes[quizIndex].questions = newQuestions;
                    showMessageBox('Quiz updated successfully!', hideAddEditQuizForm);
                }
            } else {
                // Adding new quiz
                const newQuiz = {
                    id: 'q' + Date.now(), // Simple unique ID
                    topic: quizTopic,
                    difficulty: quizDifficulty,
                    category: quizCategory, // Set category
                    questions: newQuestions
                };
                quizzes.push(newQuiz);
                showMessageBox('New quiz added successfully!', hideAddEditQuizForm);
            }

            localStorage.setItem('quizData', JSON.stringify(quizzes));
            addEditQuizForm.removeAttribute('data-editing-id'); // Clear editing state
        }

        /**
         * Pre-fills the form for editing an existing quiz.
         * @param {string} quizId - The ID of the quiz to edit.
         */
        function editQuiz(quizId) {
            const quizToEdit = quizzes.find(q => q.id === quizId);
            if (quizToEdit) {
                addEditQuizForm.dataset.editingId = quizId; // Store ID for saving
                showAddQuizForm(quizToEdit);
            } else {
                showMessageBox('Quiz not found for editing.');
            }
        }

        /**
         * Deletes a quiz.
         * @param {string} quizId - The ID of the quiz to delete.
         */
        function deleteQuiz(quizId) {
            showMessageBox('Are you sure you want to delete this quiz?', () => {
                quizzes = quizzes.filter(q => q.id !== quizId);
                localStorage.setItem('quizData', JSON.stringify(quizzes));
                loadAdminQuizList(); // Refresh the list
                showMessageBox('Quiz deleted successfully.');
            });
        }

        /**
         * Loads and displays the leaderboard.
         */
        function loadLeaderboard() {
            leaderboardList.innerHTML = ''; // Clear existing list

            const usersWithScores = users.map(user => {
                const totalScoreSum = user.scores ? user.scores.reduce((sum, s) => sum + s.score, 0) : 0;
                const totalQuizzes = user.scores ? user.scores.length : 0;
                const averageScore = totalQuizzes > 0 ? (totalScoreSum / totalQuizzes) : 0;
                return {
                    username: user.username,
                    averageScore: averageScore,
                    totalQuizzes: totalQuizzes
                };
            }).filter(user => user.totalQuizzes > 0); // Only show users who have taken quizzes

            if (usersWithScores.length === 0) {
                leaderboardList.innerHTML = '<li class="text-gray-500">No users on the leaderboard yet. Take some quizzes!</li>';
                return;
            }

            // Sort by average score descending, then by total quizzes descending
            usersWithScores.sort((a, b) => {
                if (b.averageScore === a.averageScore) {
                    return b.totalQuizzes - a.totalQuizzes;
                }
                return b.averageScore - a.averageScore;
            });

            usersWithScores.slice(0, 5).forEach((user, index) => { // Show top 5
                const listItem = document.createElement('li');
                listItem.className = 'flex justify-between items-center py-2 px-4 rounded-lg bg-gray-50 shadow-sm';
                listItem.innerHTML = `
                    <span class="font-medium text-gray-800">${index + 1}. ${user.username}</span>
                    <span class="text-gray-600">${user.averageScore.toFixed(1)}% Avg. (${user.totalQuizzes} quizzes)</span>
                `;
                leaderboardList.appendChild(listItem);
            });
        }


        // --- AI Integration Functions ---

        /**
         * Generates quiz questions using the Gemini AI API.
         * @param {string} topic - The topic for the quiz questions.
         * @param {number} numQuestions - Number of questions to generate.
         * @param {string} difficulty - Difficulty level for the questions.
         */
        async function generateQuestionsWithAI(topic, numQuestions, difficulty) {
            if (!topic.trim()) {
                aiGenerationErrorMessage.textContent = "Please enter a topic to generate AI questions.";
                aiGenerationErrorMessage.classList.remove('hidden');
                return;
            }
            if (numQuestions < 1 || numQuestions > 15) {
                aiGenerationErrorMessage.textContent = "Number of questions must be between 1 and 15.";
                aiGenerationErrorMessage.classList.remove('hidden');
                return;
            }

            aiLoadingSpinner.classList.remove('hidden');
            generateAiQuizBtn.disabled = true;
            aiGenerationErrorMessage.classList.add('hidden');

            try {
                let chatHistory = [];
                const prompt = `Generate ${numQuestions} multiple-choice quiz questions about "${topic}". Each question should be ${difficulty} difficulty, have 4 options, one correct answer. Provide the output as a JSON array of objects, where each object has 'text', 'options' (an array of strings), and 'correct' fields.`;
                chatHistory.push({ role: "user", parts: [{ text: prompt }] });

                const payload = {
                    contents: chatHistory,
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: {
                            type: "ARRAY",
                            items: {
                                type: "OBJECT",
                                properties: {
                                    "text": { "type": "STRING" },
                                    "options": {
                                        "type": "ARRAY",
                                        "items": { "type": "STRING" }
                                    },
                                    "correct": { "type": "STRING" }
                                },
                                "required": ["text", "options", "correct"]
                            }
                        }
                    }
                };

                const apiKey = ""; // Canvas will provide this at runtime
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`API error: ${response.status} ${response.statusText} - ${JSON.stringify(errorData)}`);
                }

                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const jsonString = result.candidates[0].content.parts[0].text;
                    const generatedQuestions = JSON.parse(jsonString);

                    if (generatedQuestions.length > 0) {
                        const newAiQuiz = {
                            id: 'ai-generated-' + Date.now(),
                            topic: topic,
                            difficulty: difficulty, // Use selected difficulty
                            category: 'AI Generated', // AI generated quizzes have their own category
                            questions: generatedQuestions,
                            isAiGenerated: true // Flag to identify AI-generated quizzes
                        };
                        quizzes.push(newAiQuiz);
                        localStorage.setItem('quizData', JSON.stringify(quizzes));
                        showMessageBox('AI Quiz generated and added! Starting quiz now.', () => {
                            currentQuiz = newAiQuiz; // Set the new AI quiz as current
                            startQuiz();
                        });
                    } else {
                        aiGenerationErrorMessage.textContent = "AI generated no questions. Please try a different topic.";
                        aiGenerationErrorMessage.classList.remove('hidden');
                    }
                } else {
                    aiGenerationErrorMessage.textContent = "AI response was empty or malformed. Please try again.";
                    aiGenerationErrorMessage.classList.remove('hidden');
                }
            } catch (error) {
                console.error("Error generating AI questions:", error);
                aiGenerationErrorMessage.textContent = `Failed to generate questions: ${error.message}. Please try again.`;
                aiGenerationErrorMessage.classList.remove('hidden');
            } finally {
                aiLoadingSpinner.classList.add('hidden');
                generateAiQuizBtn.disabled = false;
            }
        }

        /**
         * Generates an AI explanation for an incorrect answer during the quiz.
         */
        async function getAiExplanation() {
            const currentQuestion = currentQuiz.questions[currentQuestionIndex];
            const selectedAnswer = userAnswers[currentQuestionIndex];
            const questionText = currentQuestion.text;
            const correctAnswer = currentQuestion.correct;

            getAiExplanationBtn.disabled = true;
            aiExplanationSpinner.classList.remove('hidden');

            try {
                let chatHistory = [];
                const prompt = `The question was: "${questionText}". The correct answer was "${correctAnswer}". The user's answer was "${selectedAnswer}". Explain why the user's answer is incorrect and why the correct answer is correct. Keep the explanation concise and easy to understand.`;
                chatHistory.push({ role: "user", parts: [{ text: prompt }] });

                const payload = {
                    contents: chatHistory,
                    generationConfig: {
                        responseMimeType: "text/plain" // Request plain text response
                    }
                };

                const apiKey = ""; // Canvas will provide this at runtime
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`API error: ${response.status} ${response.statusText} - ${JSON.stringify(errorData)}`);
                }

                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const explanation = result.candidates[0].content.parts[0].text;
                    showMessageBox(`AI Explanation:\n\n${explanation}`);
                } else {
                    showMessageBox("AI could not generate an explanation. Please try again.");
                }
            } catch (error) {
                console.error("Error generating AI explanation:", error);
                showMessageBox(`Failed to get AI explanation: ${error.message}.`);
            } finally {
                getAiExplanationBtn.disabled = false;
                aiExplanationSpinner.classList.add('hidden');
            }
        }

        /**
         * Generates an AI explanation for an incorrect answer during quiz review.
         * This is a separate function to avoid conflicts with the main quiz flow's button state.
         */
        async function getAiExplanationForReview(questionText, correctAnswer, userAnswer) {
            showMessageBox(`
                <div class="flex items-center justify-center text-purple-600">
                    <div class="spinner mr-2"></div>
                    Getting explanation...
                </div>
            `); // Show loading spinner in message box

            try {
                let chatHistory = [];
                const prompt = `The question was: "${questionText}". The correct answer was "${correctAnswer}". The user's answer was "${userAnswer}". Explain why the user's answer is incorrect and why the correct answer is correct. Keep the explanation concise and easy to understand.`;
                chatHistory.push({ role: "user", parts: [{ text: prompt }] });

                const payload = {
                    contents: chatHistory,
                    generationConfig: {
                        responseMimeType: "text/plain" // Request plain text response
                    }
                };

                const apiKey = ""; // Canvas will provide this at runtime
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`API error: ${response.status} ${response.statusText} - ${JSON.stringify(errorData)}`);
                }

                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const explanation = result.candidates[0].content.parts[0].text;
                    showMessageBox(`AI Explanation:\n\n${explanation}`);
                } else {
                    showMessageBox("AI could not generate an explanation. Please try again.");
                }
            } catch (error) {
                console.error("Error generating AI explanation for review:", error);
                showMessageBox(`Failed to get AI explanation: ${error.message}.`);
            }
        }

        /**
         * Generates an AI overview/fun facts about a quiz topic.
         * @param {string} topic - The topic to get an overview for.
         */
        async function getTopicOverviewWithAI(topic) {
            showMessageBox(`
                <div class="flex items-center justify-center text-blue-600">
                    <div class="spinner mr-2"></div>
                    Getting topic overview...
                </div>
            `); // Show loading spinner in message box

            try {
                let chatHistory = [];
                const prompt = `Provide a brief, interesting overview and a few fun facts about "${topic}". Keep it concise, around 3-5 sentences for the overview and 2-3 bullet points for fun facts.`;
                chatHistory.push({ role: "user", parts: [{ text: prompt }] });

                const payload = {
                    contents: chatHistory,
                    generationConfig: {
                        responseMimeType: "text/plain" // Request plain text response
                    }
                };

                const apiKey = ""; // Canvas will provide this at runtime
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`API error: ${response.status} ${response.statusText} - ${JSON.stringify(errorData)}`);
                }

                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const overview = result.candidates[0].content.parts[0].text;
                    showMessageBox(`✨ ${topic} Overview ✨\n\n${overview}`);
                } else {
                    showMessageBox("AI could not generate an overview for this topic. Please try again.");
                }
            } catch (error) {
                console.error("Error generating topic overview:", error);
                showMessageBox(`Failed to get topic overview: ${error.message}.`);
            }
        }

        // --- Initial Load & Event Listeners ---
        document.addEventListener('DOMContentLoaded', () => {
            // Check if a user is "logged in" from previous session (simple demo persistence)
            const storedCurrentUser = localStorage.getItem('currentUser');
            if (storedCurrentUser) {
                currentUser = JSON.parse(storedCurrentUser);
                // Find the user in the 'users' array to ensure consistency
                const foundUser = users.find(u => u.email === currentUser.email);
                if (foundUser) {
                    currentUser = foundUser; // Use the full user object from 'users' array
                    if (currentUser.role === 'admin') {
                        showAdminDashboard();
                    } else {
                        showUserDashboard();
                    }
                } else {
                    // Stored user not found in current users array, clear it
                    localStorage.removeItem('currentUser');
                    showAuthSection();
                }
            } else {
                showAuthSection();
            }

            // --- Event Listeners ---
            // Authentication Forms
            document.getElementById('login-submit-btn').addEventListener('click', handleLogin);
            document.getElementById('show-register-form-link').addEventListener('click', (e) => { e.preventDefault(); showRegisterForm(); });
            document.getElementById('show-forgot-password-form-link').addEventListener('click', (e) => { e.preventDefault(); showForgotPasswordForm(); });

            document.getElementById('register-submit-btn').addEventListener('click', handleRegister);
            document.getElementById('show-login-form-link-from-register').addEventListener('click', (e) => { e.preventDefault(); showLoginForm(); });

            document.getElementById('forgot-password-submit-btn').addEventListener('click', handleForgotPassword);
            document.getElementById('show-login-form-link-from-forgot').addEventListener('click', (e) => { e.preventDefault(); showLoginForm(); });

            // Dashboard Buttons
            document.getElementById('profile-btn').addEventListener('click', showProfile);
            document.getElementById('take-quiz-btn').addEventListener('click', showQuizSelection);
            document.getElementById('logout-btn-dashboard').addEventListener('click', logout);
            document.getElementById('hide-profile-btn').addEventListener('click', hideProfile);
            document.getElementById('start-selected-quiz-btn').addEventListener('click', startQuiz);
            document.getElementById('generate-ai-quiz-btn').addEventListener('click', () => {
                const topic = aiTopicInput.value;
                const numQuestions = parseInt(aiNumQuestionsInput.value);
                const difficulty = aiDifficultySelect.value;
                generateQuestionsWithAI(topic, numQuestions, difficulty);
            });
            document.getElementById('back-to-dashboard-from-result-btn').addEventListener('click', showUserDashboard);
            document.getElementById('view-quiz-review-btn').addEventListener('click', () => showQuizReviewSection(currentQuizQuestions, userAnswers)); // Pass current quiz data for review
            document.getElementById('back-to-dashboard-from-review-btn').addEventListener('click', showUserDashboard); // Back from review
            document.getElementById('take-featured-quiz-btn').addEventListener('click', () => {
                // currentQuiz should already be set by loadFeaturedQuiz
                if (currentQuiz) {
                    startQuiz();
                } else {
                    showMessageBox('No featured quiz available right now. Please select from the list.');
                }
            });


            // Quiz Navigation Buttons
            prevBtn.addEventListener('click', prevQuestion);
            nextBtn.addEventListener('click', nextQuestion);
            getAiExplanationBtn.addEventListener('click', getAiExplanation); 
            pauseTimerBtn.addEventListener('click', pauseTimer); // New timer buttons
            resumeTimerBtn.addEventListener('click', resumeTimer); // New timer buttons
            lifeline5050Btn.addEventListener('click', use5050Lifeline); // New 50/50 lifeline listener

            // Quiz Search Input & Category Filter
            quizSearchInput.addEventListener('input', (event) => {
                loadQuizTopics(event.target.value, quizCategoryFilter.value);
            });
            quizCategoryFilter.addEventListener('change', (event) => {
                loadQuizTopics(quizSearchInput.value, event.target.value);
            });

            // Admin Dashboard Buttons
            document.getElementById('logout-btn-admin').addEventListener('click', logout);
            document.getElementById('add-new-quiz-btn').addEventListener('click', () => showAddQuizForm());
            document.getElementById('save-quiz-btn').addEventListener('click', saveQuiz);
            document.getElementById('cancel-quiz-form-btn').addEventListener('click', hideAddEditQuizForm);
            document.getElementById('add-another-question-btn').addEventListener('click', addQuestionField);
        });

        // Save current user to local storage on every change (simple session management)
        window.addEventListener('beforeunload', () => {
            if (currentUser) {
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
            } else {
                localStorage.removeItem('currentUser');
            }
        });
    </script>
</body>
</html>
